<!DOCTYPE html>
<html lang="en" data-theme="night">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vishpr Agent</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-base-300 text-base-content">

  <!-- Header -->
  <header class="navbar bg-base-200 border-b border-base-content/10 px-4 min-h-14 gap-2">
    <div class="navbar-start gap-2">
      <img src="icon-128.png" alt="vishpr" class="w-8 h-8 rounded-lg shrink-0">
      <div class="min-w-0">
        <h1 id="headerTitle" class="text-sm font-semibold leading-tight truncate">vishpr</h1>
        <div class="flex items-center gap-2 text-xs opacity-50">
          <span class="status status-xs" id="statusDot"></span>
          <span id="statusText" class="truncate">Ready</span>
        </div>
      </div>
    </div>
    <div class="navbar-end gap-1">
      <button id="debugToggle" class="btn btn-ghost btn-sm btn-square" title="Debug Mode">
        <svg class="size-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A1.5 1.5 0 1 0 9 14.5A1.5 1.5 0 0 0 7.5 13m9 0a1.5 1.5 0 1 0 1.5 1.5a1.5 1.5 0 0 0-1.5-1.5"/>
        </svg>
      </button>
      <button id="settingsToggle" class="btn btn-ghost btn-sm btn-square" title="Settings">
        <svg class="size-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Settings Panel -->
  <div class="hidden bg-base-200 border-b border-base-content/10" id="settingsPanel">
    <div class="p-3 h-[45vh] flex flex-col">
      <!-- Settings Tabs -->
      <div role="tablist" class="tabs tabs-boxed bg-base-300 settings-tabs shrink-0">
        <button role="tab" class="tab tab-active text-xs font-medium" data-settings-tab="models">
          <svg class="w-3.5 h-3.5 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
          </svg>
          Models
        </button>
        <button role="tab" class="tab text-xs font-medium" data-settings-tab="ui">
          <svg class="w-3.5 h-3.5 mr-1.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8"/><path d="M12 17v4"/>
          </svg>
          Interface
        </button>
      </div>

      <!-- Models Tab Content -->
      <div id="settingsModelsTab" class="flex-1 overflow-y-auto mt-3">
        <!-- Endpoints Section -->
        <div class="mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-medium opacity-50">API Endpoints</span>
            <button id="addEndpointBtn" class="btn btn-ghost btn-xs gap-1" title="Add endpoint">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14"/>
              </svg>
              Add
            </button>
          </div>
          <ul id="endpointsList" class="list bg-base-300 rounded-lg min-h-10"></ul>
        </div>

        <div class="divider my-2 opacity-30"></div>

        <div id="modelsBody" class="space-y-3">
          <div class="tier-section" data-tier="HIGH">
            <div class="flex items-center justify-between mb-2">
              <span class="badge badge-error badge-sm">HIGH</span>
              <button class="btn btn-ghost btn-xs btn-square tier-add-btn" data-tier="HIGH" title="Add model">+</button>
            </div>
            <ul class="list bg-base-300 rounded-lg min-h-10" id="modelListHigh"></ul>
          </div>
          <div class="tier-section" data-tier="MEDIUM">
            <div class="flex items-center justify-between mb-2">
              <span class="badge badge-warning badge-sm">MEDIUM</span>
              <button class="btn btn-ghost btn-xs btn-square tier-add-btn" data-tier="MEDIUM" title="Add model">+</button>
            </div>
            <ul class="list bg-base-300 rounded-lg min-h-10" id="modelListMedium"></ul>
          </div>
          <div class="tier-section" data-tier="LOW">
            <div class="flex items-center justify-between mb-2">
              <span class="badge badge-success badge-sm">LOW</span>
              <button class="btn btn-ghost btn-xs btn-square tier-add-btn" data-tier="LOW" title="Add model">+</button>
            </div>
            <ul class="list bg-base-300 rounded-lg min-h-10" id="modelListLow"></ul>
          </div>
        </div>
        <div class="flex justify-end pt-2 border-t border-base-content/10">
          <button class="btn btn-ghost btn-sm" id="resetModelsBtn">Reset to Defaults</button>
        </div>
      </div>

      <!-- UI Tab Content -->
      <div id="settingsUiTab" class="hidden flex-1 overflow-y-auto mt-3">
        <!-- Theme Selection -->
        <div class="card bg-base-300 p-3 mb-3">
          <div class="text-sm font-medium mb-3">Theme</div>
          <div id="themeSelector" class="grid grid-cols-4 gap-2">
            <button class="theme-btn btn btn-ghost flex flex-col items-center gap-2 p-2 h-auto" data-theme="cupcake">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-200 to-pink-100 border-2 border-pink-300"></div>
              <span class="text-xs opacity-50">Cupcake</span>
            </button>
            <button class="theme-btn btn btn-ghost flex flex-col items-center gap-2 p-2 h-auto" data-theme="retro">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-amber-200 to-orange-200 border-2 border-amber-400"></div>
              <span class="text-xs opacity-50">Retro</span>
            </button>
            <button class="theme-btn btn btn-ghost flex flex-col items-center gap-2 p-2 h-auto" data-theme="sunset">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-orange-400 to-rose-500 border-2 border-orange-500"></div>
              <span class="text-xs opacity-50">Sunset</span>
            </button>
            <button class="theme-btn btn btn-ghost flex flex-col items-center gap-2 p-2 h-auto" data-theme="night">
              <div class="w-8 h-8 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 border-2 border-indigo-500"></div>
              <span class="text-xs opacity-50">Night</span>
            </button>
          </div>
        </div>

        <!-- Zoom Controls -->
        <div class="card bg-base-300 p-3 mb-3">
          <div class="flex items-center justify-between mb-3">
            <div class="text-sm font-medium">Zoom</div>
            <div class="flex items-center gap-2">
              <button id="zoomOut" class="btn btn-ghost btn-sm btn-square" title="Zoom out">−</button>
              <span id="zoomLevel" class="badge badge-ghost text-sm font-mono min-w-14">100%</span>
              <button id="zoomIn" class="btn btn-ghost btn-sm btn-square" title="Zoom in">+</button>
            </div>
          </div>
          <input type="range" id="zoomSlider" min="70" max="150" value="100" step="10" class="range range-xs range-primary w-full">
          <div class="flex justify-between text-xs opacity-50 mt-1">
            <span>70%</span>
            <span>150%</span>
          </div>
        </div>

        <!-- Panel Position -->
        <div class="card bg-base-300 p-3 mt-3">
          <div class="flex items-center justify-between">
            <div class="text-sm font-medium">Panel Position</div>
            <button id="openPositionSettings" class="btn btn-ghost btn-xs gap-1" title="Open Chrome settings">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                <polyline points="15 3 21 3 21 9"/>
                <line x1="10" y1="14" x2="21" y2="3"/>
              </svg>
              Settings
            </button>
          </div>
          <p class="text-xs opacity-40 mt-2">Set via Chrome → Settings → Appearance → Sidebar</p>
        </div>

        <div class="flex justify-end pt-3">
          <button class="btn btn-ghost btn-sm" id="resetUiBtn">Reset to Defaults</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Debug Container -->
  <div class="hidden flex-1 flex flex-col overflow-hidden" id="debugContainer">
    <!-- Debug Tabs -->
    <div role="tablist" class="tabs tabs-boxed bg-base-300 mx-2 mb-2 shrink-0">
      <button role="tab" class="tab tab-active text-xs" data-debug-tab="trace">Trace</button>
      <button role="tab" class="tab text-xs" data-debug-tab="stats">Stats</button>
      <button role="tab" class="tab text-xs" data-debug-tab="state">State</button>
    </div>

    <!-- Debug Content: History + Stacked Timeline -->
    <div id="debugTraceTab" class="flex-1 flex overflow-hidden">
      <!-- History Sidebar -->
      <div class="w-1/4 min-w-24 max-w-32 border-r border-base-content/10 flex flex-col bg-base-200/50">
        <div class="p-2 border-b border-base-content/10 flex items-center justify-between">
          <span class="text-xs font-medium opacity-50">History</span>
          <button id="debugClearBtn" class="btn btn-ghost btn-xs btn-square opacity-50 hover:opacity-100" title="Refresh"><svg class="size-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg></button>
        </div>
        <div id="debugHistory" class="flex-1 overflow-y-auto p-1 space-y-1"></div>
      </div>

      <!-- Unified Timeline: Trace + Critique stacked -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Timeline Header -->
        <div class="px-3 py-2 bg-base-200 border-b border-base-content/10 flex items-center gap-3">
          <span id="debugTiming" class="text-xs opacity-40 font-mono"></span>
          <div class="flex-1"></div>
          <span id="debugCritiqueBadge" class="badge badge-xs"></span>
          <button id="debugRefreshBtn" class="btn btn-ghost btn-xs btn-square opacity-50 hover:opacity-100" title="Refresh critique"><svg class="size-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg></button>
        </div>
        <!-- Stacked Timeline Content -->
        <div id="debugTimeline" class="flex-1 overflow-y-auto">
          <div class="debug-empty-state">
            <div class="debug-empty-icon">▷</div>
            <div class="debug-empty-text">Select a trace from history</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Tab Content -->
    <div id="debugStatsTab" class="hidden flex-1 flex flex-col overflow-hidden">
      <!-- Stats Header -->
      <div class="px-3 py-2 bg-base-200 border-b border-base-content/10 flex items-center justify-between shrink-0">
        <span class="text-xs opacity-40">Usage statistics</span>
        <button id="debugStatsRefreshBtn" class="btn btn-ghost btn-xs gap-1 opacity-60 hover:opacity-100" title="Refresh stats">
          <svg class="size-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
          <span class="text-[10px]">Refresh</span>
        </button>
      </div>
      <!-- Stats Content -->
      <div class="flex-1 overflow-y-auto p-3 space-y-4">
      <!-- Model Stats Section -->
      <div class="stats-section">
        <div class="flex items-center gap-2 mb-2 opacity-60">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
          </svg>
          <span class="text-xs font-medium tracking-wide uppercase">Model Stats</span>
        </div>
        <div class="model-stats-container space-y-2" id="modelStatsContainer">
          <div class="stats-empty text-center py-6 opacity-40">
            <p class="text-xs">No model stats yet</p>
          </div>
        </div>
      </div>

      <!-- Action Stats Section -->
      <div class="stats-section">
        <div class="flex items-center gap-2 mb-2 opacity-60">
          <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
          </svg>
          <span class="text-xs font-medium tracking-wide uppercase">Action Stats</span>
        </div>
        <div class="action-stats-container space-y-2" id="actionStatsContainer">
          <div class="stats-empty text-center py-6 opacity-40">
            <p class="text-xs">No action stats yet</p>
          </div>
        </div>
      </div>
      </div>
    </div>

    <!-- State Tab Content -->
    <div id="debugStateTab" class="hidden flex-1 flex flex-col overflow-hidden">
      <!-- State Header -->
      <div class="px-3 py-2 bg-base-200 border-b border-base-content/10 flex items-center justify-between shrink-0">
        <span class="text-xs opacity-40 font-mono">Runtime state inspector</span>
        <button id="debugStateRefreshBtn" class="btn btn-ghost btn-xs gap-1 opacity-60 hover:opacity-100" title="Refresh state">
          <svg class="size-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
          <span class="text-[10px]">Refresh</span>
        </button>
      </div>
      <!-- State Content -->
      <div id="debugStateContent" class="flex-1 overflow-y-auto p-3 space-y-3">
        <div class="state-empty text-center py-8 opacity-40">
          <p class="text-xs font-mono">Loading state...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="flex-1 overflow-y-auto p-3 space-y-3" id="chatContainer">
    <div class="empty-state flex-1 flex flex-col items-center justify-center text-center py-8 opacity-50">
      <svg class="w-12 h-12 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
      <p class="text-sm">Ready to help.<br>Ask me to interact with this page.</p>
    </div>
  </div>

  <!-- Input Area -->
  <div class="bg-base-200 border-t border-base-content/10 p-3">
    <div class="flex gap-2 items-end">
      <textarea id="messageInput" class="textarea textarea-bordered flex-1 min-h-10 max-h-32 text-sm resize-none leading-relaxed" placeholder="Read the page, click a button, fill a form..." rows="1"></textarea>
      <button id="sendButton" class="btn btn-primary btn-square" title="Send">
        <svg class="size-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
      </button>
    </div>
    <p class="text-xs opacity-50 text-center mt-2"><kbd class="kbd kbd-xs">Enter</kbd> to send · <kbd class="kbd kbd-xs">Shift+Enter</kbd> for new line</p>
  </div>

  <!-- Templates -->
  <!-- Endpoint Templates -->
  <template id="tpl-endpoint-item">
    <li class="list-row items-center gap-3">
      <div class="endpoint-status flex items-center"></div>
      <div class="flex items-center gap-2 min-w-0 flex-1">
        <span class="endpoint-name badge badge-outline badge-sm font-mono"></span>
      </div>
      <div class="endpoint-key text-xs opacity-40 truncate max-w-24"></div>
      <button class="btn btn-ghost btn-xs btn-square edit" title="Edit"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
      <button class="btn btn-ghost btn-xs btn-square delete hover:btn-error" title="Remove"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
    </li>
  </template>
  <template id="tpl-endpoint-editing">
    <li class="list-row items-center bg-base-200">
      <div class="list-col-grow min-w-0 flex flex-col gap-1.5">
        <div class="flex gap-2">
          <select class="endpoint-type-select select select-xs select-bordered flex-1">
            <option value="">Custom...</option>
          </select>
          <input type="text" class="endpoint-name-input input input-xs input-bordered flex-1 hidden" placeholder="endpoint-name">
        </div>
        <input type="text" class="endpoint-url-input input input-xs input-bordered w-full font-mono text-xs" placeholder="https://api.example.com/v1/chat/completions">
        <input type="password" class="endpoint-key-input input input-xs input-bordered w-full" placeholder="API key (optional)">
      </div>
      <button class="btn btn-ghost btn-xs btn-square save hover:btn-success" title="Save"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg></button>
      <button class="btn btn-ghost btn-xs btn-square cancel" title="Cancel"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
    </li>
  </template>

  <!-- Model Templates -->
  <template id="tpl-model-item">
    <li class="list-row items-center model-draggable">
      <div class="status-indicator flex items-center"></div>
      <div class="list-col-grow min-w-0">
        <div class="flex items-center gap-2">
          <span class="model-endpoint badge badge-ghost badge-xs opacity-60"></span>
          <span class="model-name text-xs font-mono truncate"></span>
          <span class="model-provider text-[0.65rem] opacity-40"></span>
          <span class="warning-indicator hidden"></span>
        </div>
        <div class="model-stats flex items-center gap-2 text-xs opacity-50 mt-0.5"></div>
      </div>
      <button class="btn btn-ghost btn-xs btn-square edit" title="Edit"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
      <button class="btn btn-ghost btn-xs btn-square delete hover:btn-error" title="Remove"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      <div class="drag-handle opacity-30 hover:opacity-60 transition-opacity ml-1"><svg width="8" height="12" viewBox="0 0 10 14" fill="currentColor"><circle cx="2" cy="2" r="1.5"/><circle cx="8" cy="2" r="1.5"/><circle cx="2" cy="7" r="1.5"/><circle cx="8" cy="7" r="1.5"/><circle cx="2" cy="12" r="1.5"/><circle cx="8" cy="12" r="1.5"/></svg></div>
    </li>
  </template>
  <template id="tpl-model-editing">
    <li class="list-row items-center bg-base-200">
      <div class="list-col-grow min-w-0 flex flex-col gap-1.5">
        <select class="model-endpoint-select select select-xs select-bordered w-full"></select>
        <div class="dropdown dropdown-bottom dropdown-open w-full">
          <input type="text" class="model-name-input input input-xs input-bordered w-full font-mono" placeholder="model-name" autocomplete="off">
          <ul class="model-autocomplete dropdown-content flex flex-col bg-base-200 rounded-lg z-50 w-full max-h-48 overflow-y-auto shadow-lg border border-base-content/10 p-1 hidden"></ul>
        </div>
        <div class="model-router-row hidden">
          <div class="dropdown dropdown-bottom dropdown-open w-full">
            <input type="text" class="model-router-input input input-xs input-bordered w-full" placeholder="provider (optional)" autocomplete="off">
            <ul class="router-autocomplete dropdown-content flex flex-col bg-base-200 rounded-lg z-50 w-full max-h-48 overflow-y-auto shadow-lg border border-base-content/10 p-1 hidden"></ul>
          </div>
        </div>
      </div>
      <button class="btn btn-ghost btn-xs btn-square save hover:btn-success" title="Save"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg></button>
      <button class="btn btn-ghost btn-xs btn-square cancel" title="Cancel"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
    </li>
  </template>
  <template id="tpl-stats-card">
    <div class="model-stat-card bg-base-300 rounded-lg p-3 border border-base-content/10">
      <div class="flex items-center gap-2">
        <div class="radial-progress text-xs font-mono shrink-0" style="--size:3rem; --thickness:3px;" role="progressbar"><span class="stat-rate text-xs font-semibold"></span></div>
        <div class="flex-1 min-w-0"><div class="stat-model font-mono text-xs truncate"></div><div class="stat-provider text-xs opacity-50"></div>
          <div class="flex gap-2 mt-1"><span class="text-xs text-success flex items-center gap-2"><span class="inline-block w-1.5 h-1.5 rounded-full bg-current opacity-50"></span><span class="stat-success"></span></span><span class="text-xs text-error flex items-center gap-2"><span class="inline-block w-1.5 h-1.5 rounded-full bg-current opacity-50"></span><span class="stat-error"></span></span><span class="stat-total text-xs opacity-50"></span></div>
        </div>
      </div>
    </div>
  </template>
  <template id="tpl-stats-summary">
    <div class="stats-summary bg-base-300/50 rounded-lg p-3 mb-3 border border-base-content/5">
      <div class="flex items-center justify-between"><div class="text-xs font-medium opacity-50">Overall Performance</div>
        <div class="flex items-center gap-3"><div class="text-right"><div class="summary-rate text-lg font-mono font-semibold"></div><div class="summary-calls text-xs opacity-50"></div></div><div class="flex flex-col gap-0.5 text-xs"><span class="summary-ok text-success"></span><span class="summary-err text-error"></span></div></div>
      </div>
    </div>
  </template>

  <!-- User Clarification Overlay -->
  <dialog id="clarificationOverlay" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box clarification-panel">
      <!-- Timer bar - the "lifeline" -->
      <div class="clarification-lifeline">
        <div class="lifeline-track">
          <div class="lifeline-fill"></div>
        </div>
        <div class="lifeline-time">
          <span class="timer-seconds">15</span>
        </div>
      </div>

      <!-- Question -->
      <div class="clarification-question">
        <h3 class="question-text"></h3>
        <p class="question-context"></p>
      </div>

      <!-- Options -->
      <div class="clarification-options-wrap">
        <div class="options-status">
          <span class="options-label">Choose an option</span>
          <span class="options-loading hidden">
            <span class="loading loading-dots loading-xs"></span>
          </span>
        </div>
        <div class="clarification-options">
          <div class="option-skeleton skeleton"></div>
          <div class="option-skeleton skeleton"></div>
          <div class="option-skeleton skeleton"></div>
        </div>
      </div>

      <!-- Custom input -->
      <div class="clarification-custom">
        <div class="divider text-xs opacity-50 my-2">or type your answer</div>
        <div class="join w-full">
          <input type="text" class="input input-bordered input-sm join-item flex-1 clarification-input" placeholder="Something else...">
          <button class="btn btn-sm btn-primary join-item clarification-submit-btn">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>

      <!-- Progress dots -->
      <div class="clarification-progress"></div>

      <!-- Hint -->
      <div class="clarification-hint hidden">
        <div class="alert alert-info text-xs py-2">
          <svg class="w-4 h-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
          <span class="hint-text"></span>
        </div>
      </div>

      <!-- Paused badge -->
      <div class="clarification-paused hidden">
        <span class="badge badge-warning badge-sm gap-1">
          <span class="loading loading-ring loading-xs"></span>
          Paused
        </span>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop"><button>close</button></form>
  </dialog>

  <!-- Clarification Option Template -->
  <template id="tpl-clarification-option">
    <button class="clarification-option btn btn-block justify-between h-auto min-h-0 py-3 px-4 gap-3">
      <div class="flex items-center gap-3">
        <span class="option-rank badge badge-sm font-mono"></span>
        <span class="option-label text-left font-normal leading-snug"></span>
      </div>
      <progress class="option-confidence progress progress-primary w-12 h-1" value="0" max="100"></progress>
    </button>
  </template>

  <script src="sidepanel.js" type="module"></script>
</body>
</html>
